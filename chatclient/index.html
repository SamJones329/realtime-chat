<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Client</title>

    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>

<body>
    <div>
        <span id="connected">Disconnected</span>
        <div id="message-box"></div>
        <form id="message-form">
            <input id="username-input" type="text" placeholder="Enter username">
            <input id="message-input" type="text" placeholder="Send a message">
            <button>Send</button>
        </form>
    </div>
</body>

<script>
    const messageBox = document.querySelector("#message-box");
    const connectedElem = document.querySelector("#connected");

    const stompClient = new StompJs.Client({
        brokerURL: 'ws://localhost:8080/chatws'
    });

    let reconnectTime = 500; // ms
    const reconnectTimeIncrement = 500;
    const maxReconnectTime = 2000;
    const reconnect = () => {
        setTimeout(() => {
            stompClient.activate();
        }, reconnectTime)
        if (reconnectTime < maxReconnectTime) {
            reconnectTime += reconnectTimeIncrement;
        }
    }

    stompClient.onConnect = (frame) => {
        reconnectTime = reconnectTimeIncrement;
        setConnected(true);
        console.log('Connected: ' + frame);
        stompClient.subscribe('/topic/chat', (chatMessage) => {
            console.log(chatMessage)
            console.log(JSON.parse(chatMessage.body))
            const { username, message } = JSON.parse(chatMessage.body)
            let messageContainer = document.createElement("div");
            messageContainer.innerText = `${username}: ${message}`
            messageBox.append(messageContainer);
        });
    };

    stompClient.onWebSocketError = (error) => {
        console.error(`Error with websocket, trying to reconnect in ${reconnectTime}ms`, error);
        reconnect();
    };

    stompClient.onDisconnect = () => {
        console.error(`Websocket disconnected, trying to reconnect in ${reconnectTime}ms`);
        reconnect();
    }

    stompClient.onStompError = (frame) => {
        console.error('Broker reported error: ' + frame.headers['message']);
        console.error('Additional details: ' + frame.body);
    };

    function setConnected(/** @type{boolean} */ connected) {
        if (connectedElem) connectedElem.innerText = connected ? "Connected" : "Disconnected";
    }

    stompClient.activate();
    document.querySelector('#message-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        /** @type{HTMLInputElement} */
        const usernameInput = document.querySelector('input#username-input')
        /** @type{HTMLInputElement} */
        const messageInput = document.querySelector('input#message-input')
        stompClient.publish({
            destination: "/app/chat",
            body: JSON.stringify({ username: usernameInput.value, message: messageInput.value })
        })
    })

</script>

</html>